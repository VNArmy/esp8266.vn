<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Tuan PM">
  
  <title>Cập nhật Firmware (FOTA) - Internet Of Things (IoT) với ESP8266</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  <link rel="stylesheet" href="../../css/custom.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Cập nhật Firmware (FOTA)";
    var mkdocs_page_input_path = "arduino/arduino-fota.md";
    var mkdocs_page_url = "/arduino/arduino-fota/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script>
  <script src="../../js/jquery.cookie-1.4.1.min.js"></script>
  <script src="../../js/nav.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60470603-4', 'esp8266.vn');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Internet Of Things (IoT) với ESP8266</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../.." id="Trang chủ" style="font-size:95%;font-weight:bold;">Trang chủ</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="current">
        <a class="current"  id="Nội dung" style="font-size:95%;font-weight:bold;">Nội dung</a>
    </li>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="Kiến thức cơ bản" onclick="showChildren('Kiến thức cơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> Kiến thức cơ bản</a>
        </li>
        
        <div style="display:none" id="hidden_Kiến thức cơ bản">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/introduction/" id="Tổng quan">  Tổng quan </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quan">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/about-iot/" id="Internet Of Things (IoT)">  Internet Of Things (IoT) </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/about-esp8266/" id="ESP8266 & ESP8285">  ESP8266 & ESP8285 </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/esp-module/" id="Module & Board phát triển">  Module & Board phát triển </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285Module & Board phát triển">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/prepare/" id="Phần cứng & công cụ">  Phần cứng & công cụ </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285Module & Board phát triểnPhần cứng & công cụ">
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 NONOS-SDK" onclick="showChildren('ESP8266 NONOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 NONOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 NONOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../nonos-sdk/nonos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/basic/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/compile-first-time/" id="Biên dịch dự án mẫu">Biên dịch dự án mẫu </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/blink-led/" id="Bật tắt LED">Bật tắt LED </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/button/" id="Nút nhấn">Nút nhấn </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/uart/" id="UART">UART </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/complex-makefile/" id="Makefile cho dự án phức tạp">Makefile cho dự án phức tạp </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/task/" id="Task">Task </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/wifi/" id="Wifi">Wifi </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/espconn/" id="ESPCONN">ESPCONN </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/mdns/" id="MDNS">MDNS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/ntp/" id="NTP">NTP </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/save-to-flash/" id="Lưu dữ liệu vào Flash">Lưu dữ liệu vào Flash </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Smartconfig" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfig')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Smartconfig </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfig">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/smartconfig/" id="ESP8266 Smartconfig">ESP8266 Smartconfig </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/why-smartconfig/" id="Tại sao cần Smartconfig">Tại sao cần Smartconfig </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/esptouch/" id="ESPTOUCH & AIRKISS">ESPTOUCH & AIRKISS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/wps/" id="WPS">WPS </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="MQTT" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTT')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  MQTT </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTT">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/mqtt/what-is-mqtt/" id="Giao thức MQTT">Giao thức MQTT </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/mqtt/mqtt-client/" id="ESP8266 MQTT Client">ESP8266 MQTT Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Client" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP Client')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Client </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP Client">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/http-client/http-client/" id="ESP8266 HTTP Client">ESP8266 HTTP Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Server" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP Server')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Server </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP Server">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/http-server/http-server/" id="ESP8266 HTTP Server">ESP8266 HTTP Server </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Firmware Over The Air" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The Air')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Firmware Over The Air </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The Air">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/fota/fota/" id="FOTA">FOTA </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Now" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP Now')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Now </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP Now">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/esp-now/esp-now/" id="ESP Now">ESP Now </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Mesh" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP Mesh')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Mesh </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP Mesh">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/esp-mesh/esp-mesh/" id="ESP Mesh">ESP Mesh </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Các dự án" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP MeshCác dự án')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Các dự án </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP MeshCác dự án">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/projects/list/" id="Danh sách">Danh sách </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 FreeRTOS-SDK" onclick="showChildren('ESP8266 FreeRTOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 FreeRTOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../freertos-sdk/freertos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 FreeRTOS-SDKGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../freertos-sdk/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="current">
            <a style="padding-left:50px;" class="current"  id="ESP8266 Arduino" onclick="showChildren('ESP8266 Arduino')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Arduino</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Arduino">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../arduino/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/install/" id="Cài đặt">Cài đặt </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/digital/" id="Digital">Digital </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/analog/" id="Analog">Analog </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/timming-delay/" id="Thời gian & Delay">Thời gian & Delay </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/serial/" id="Serial">Serial </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/progmem/" id="Progmem">Progmem </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Thư viện" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư viện')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Thư viện </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư viện">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../libraries/esp8266-wifi/" id="ESP8266WiFi">ESP8266WiFi </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Filesystem" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystem')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Filesystem </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystem">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../filesystem/flash-layout/" id="Flash Layout">Flash Layout </a>
                </li>
            
            </div>
        
            <li class="current">
                <a style="padding-left:70px;" class="current" href="./" id="Cập nhật Firmware (FOTA)">  Cập nhật Firmware (FOTA) </a>
                <!-- 
                    <ul>
                    
                        <li class="toctree-l3"><a href="#gioi-thieu-ota">Giới thiệu OTA</a></li>
                        
                            <li><a class="toctree-l4" href="#security">Security</a></li>
                        
                            <li><a class="toctree-l4" href="#safety">Safety</a></li>
                        
                            <li><a class="toctree-l4" href="#basic-requirements">Basic Requirements</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#arduino-ide">Arduino IDE</a></li>
                        
                            <li><a class="toctree-l4" href="#requirements">Requirements</a></li>
                        
                            <li><a class="toctree-l4" href="#application-example">Application Example</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#web-browser">Web Browser</a></li>
                        
                            <li><a class="toctree-l4" href="#requirements_1">Requirements</a></li>
                        
                            <li><a class="toctree-l4" href="#implementation-overview">Implementation Overview</a></li>
                        
                            <li><a class="toctree-l4" href="#application-example_1">Application Example</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#http-server">HTTP Server</a></li>
                        
                            <li><a class="toctree-l4" href="#requirements_2">Requirements</a></li>
                        
                            <li><a class="toctree-l4" href="#arduino-code">Arduino code</a></li>
                        
                            <li><a class="toctree-l4" href="#server-request-handling">Server request handling</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#stream-interface">Stream Interface</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#updater-class">Updater class</a></li>
                        
                            <li><a class="toctree-l4" href="#update-process-memory-view">Update process - memory view</a></li>
                        
                    
                    </ul>
                 -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../arduino-esp8266-hardware/" id="Phần cứng hỗ trợ">  Phần cứng hỗ trợ </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợ">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Các dự án" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợCác dự án')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Các dự án </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợCác dự án">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../projects/list/" id="Danh sách">Danh sách </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 Micropython" onclick="showChildren('ESP8266 Micropython')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Micropython</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Micropython">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../micropython/micropython/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 MicropythonGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../micropython/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
            </div>
        
        </div>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../projects/list/" id="Các dự án" style="font-size:95%;font-weight:bold;">Các dự án</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../license/" id="Bản quyền" style="font-size:95%;font-weight:bold;">Bản quyền</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../contributor/" id="Đóng góp" style="font-size:95%;font-weight:bold;">Đóng góp</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Internet Of Things (IoT) với ESP8266</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Nội dung &raquo;</li>
        
      
        
          <li>ESP8266 Arduino &raquo;</li>
        
      
    
    <li>Cập nhật Firmware (FOTA)</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/esp8266vn/esp8266.vn" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc">
<ul>
<li><a href="#gioi-thieu-ota">Giới thiệu OTA</a><ul>
<li><a href="#security">Security</a></li>
<li><a href="#safety">Safety</a></li>
<li><a href="#basic-requirements">Basic Requirements</a></li>
</ul>
</li>
<li><a href="#arduino-ide">Arduino IDE</a><ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#application-example">Application Example</a><ul>
<li><a href="#password-protection">Password Protection</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#web-browser">Web Browser</a><ul>
<li><a href="#requirements_1">Requirements</a></li>
<li><a href="#implementation-overview">Implementation Overview</a></li>
<li><a href="#application-example_1">Application Example</a></li>
</ul>
</li>
<li><a href="#http-server">HTTP Server</a><ul>
<li><a href="#requirements_2">Requirements</a></li>
<li><a href="#arduino-code">Arduino code</a><ul>
<li><a href="#simple-updater">Simple updater</a></li>
<li><a href="#advanced-updater">Advanced updater</a></li>
</ul>
</li>
<li><a href="#server-request-handling">Server request handling</a><ul>
<li><a href="#simple-updater_1">Simple updater</a></li>
<li><a href="#advanced-updater_1">Advanced updater</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#stream-interface">Stream Interface</a></li>
<li><a href="#updater-class">Updater class</a><ul>
<li><a href="#update-process-memory-view">Update process - memory view</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="gioi-thieu-ota">Giới thiệu OTA<a class="headerlink" href="#gioi-thieu-ota" title="Permanent link">#</a></h2>
<p>OTA (Over the Air) update is the process of loading the firmware to ESP module using Wi-Fi connection rather that a serial port. Such functionality became extremely useful in case of limited or no physical access to the module.</p>
<p>OTA may be done using:</p>
<ul>
<li><a href="#arduino-ide">Arduino IDE</a></li>
<li><a href="#web-browser">Web Browser</a></li>
<li><a href="#http-server">HTTP Server</a></li>
</ul>
<p>Arduino IDE option is intended primarily for software development phase. The two other options would be more useful after deployment, to provide module with application updates manually with a web browser or automatically using a http server.</p>
<p>In any case first firmware upload have to be done over a serial port. If OTA routines are correctly implemented in a sketch, then all subsequent uploads may be done over the air.</p>
<p>There is no imposed security on OTA process from being hacked. It is up to developer to ensure that updates are allowed only from legitimate / trusted source. Once update is complete, module restarts and new code is executed. Developer should ensure that application running on module is shut down and restarted in a safe manner. Chapters below provide additional information regarding security and safety of OTA process.</p>
<h3 id="security">Security<a class="headerlink" href="#security" title="Permanent link">#</a></h3>
<p>Module has to be exposed wirelessly to get it updated with a new sketch. That poses chances of module being violently hacked and loaded with some other code. To reduce likelihood of being hacked consider protecting your uploads with a password, selecting certain OTA port, etc.</p>
<p>Check functionality provided with <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library that may improve security:</p>
<pre class="code"><code class="language-cpp">void setPort(uint16_t port);
void setHostname(const char* hostname);
void setPassword(const char* password);</code></pre>


<p>Certain protection functionality is already built in and do not require any additional coding by developer. <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> and <code>espota.py</code> use <a href="https://en.wikipedia.org/wiki/Digest_access_authentication">Digest-MD5</a> to authenticate upload. Integrity of transferred data is verified on ESP side using <a href="https://en.wikipedia.org/wiki/MD5">MD5</a> checksum.</p>
<p>Make your own risk analysis and depending on application decide what library functions to implement. If required consider implementation of other means of protection from being hacked, e.g. exposing module for uploads only according to specific schedule, trigger OTA only be user pressing dedicated “Update” button, etc.</p>
<h3 id="safety">Safety<a class="headerlink" href="#safety" title="Permanent link">#</a></h3>
<p>OTA process takes ESP’s resources and bandwidth during upload. Then module is restarted and a new sketch executed. Analyse and test how it affects functionality of your existing and new sketch.</p>
<p>If ESP is placed in remote location and controlling some equipment, you should put additional attention what happens if operation of this equipment is suddenly interrupted by update process. Therefore decide how to put this equipment into safe state before starting the update.  For instance your module may be controlling a garden watering system in a sequence. If this sequence is not properly shut down and a water valve left open, your garden may be flooded if this valve is not closed after OTA is finished and module restarts.  </p>
<p>The following functions are provided with <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library and intended to handle functionality of your application during specific stages of OTA or on an OTA error:</p>
<pre class="code"><code class="language-cpp">void onStart(OTA_CALLBACK(fn));
void onEnd(OTA_CALLBACK(fn));
void onProgress(OTA_CALLBACK_PROGRESS(fn));
void onError(OTA_CALLBACK_ERROR (fn));</code></pre>


<h3 id="basic-requirements">Basic Requirements<a class="headerlink" href="#basic-requirements" title="Permanent link">#</a></h3>
<p>Flash chip size needs a size that is able to hold the old sketch (currently running) and the new sketch (OTA) at the same time.
Keep in mind that the File system and EEPROM for example needs space too (one time) see <a href="../filesystem/flash-layout/#flash-layout">flash layout</a>.</p>
<pre class="code"><code class="language-cpp">ESP.getFreeSketchSpace();</code></pre>


<p>can be used for checking the free space for the new sketch.</p>
<p>For overview of memory layout, where new sketch is stored and how it is copied during OTA process see <a href="#update-process---memory-view">Update process - memory view</a>.</p>
<p>The following chapters provide more details and specific methods of doing OTA.</p>
<h2 id="arduino-ide">Arduino IDE<a class="headerlink" href="#arduino-ide" title="Permanent link">#</a></h2>
<p>Uploading modules wirelessly from Arduino IDE is intended for the following typical scenarios:
- during firmware development as a quicker alternative to loading over a serial
- for updating small quantity of modules
- only if modules are available on the same network as the computer with Arduino IDE</p>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">#</a></h3>
<ul>
<li>The ESP and the computer must be connected to the same network.</li>
</ul>
<h3 id="application-example">Application Example<a class="headerlink" href="#application-example" title="Permanent link">#</a></h3>
<p>Instructions below show configuration of OTA on NodeMCU 1.0 (ESP-12E Module) board. You can use any other board assuming that it meets <a href="#basic-requirements">requirements</a> described above. This instruction is valid for all operating systems supported by Arduino IDE. Screen captures have been made on Windows 7 and you may see small differences (like name of serial port) if you are using Linux and MacOS.</p>
<ol>
<li>
<p>Before you begin, please make sure that you have the following s/w installed:</p>
<ul>
<li>Arduino IDE 1.6.7 or newer - https://www.arduino.cc/en/Main/Software</li>
<li>esp8266/Arduino platform package 2.0.0 or newer - for instructions follow https://github.com/esp8266/Arduino#installing-with-boards-manager</li>
<li>
<p>Python 2.7 (do not install Python 3.5 that is not supported) - https://www.python.org/</p>
<p><strong>Note:</strong> Windows users should select “Add python.exe to Path” (see below – this option is not selected by default).</p>
<p><img alt="Python installation set up" src="../images/a-ota-python-configuration.png" /></p>
</li>
</ul>
</li>
<li>
<p>Now prepare the sketch and configuration for the upload over a serial port.</p>
<ul>
<li>
<p>Start Arduino IDE and load sketch BasicOTA.ino available under File &gt;  Examples &gt; ArduinoOTA
    <img alt="selection of example OTA sketch" src="../images/a-ota-sketch-selection.png" /></p>
</li>
<li>
<p>Update SSID and password in the sketch so the module can join your Wi-Fi network
    <img alt="SSID and password entry" src="../images/a-ota-ssid-pass-entry.png" /></p>
</li>
<li>
<p>Configure upload parameters as below (you may need to adjust configuration if you are using a different module):
    <img alt="configuration of serial upload" src="../images/a-ota-serial-upload-configuration.png" /></p>
<p><strong>Note:</strong> Depending on version of platform package and board you have, you may see <code>Upload Using:</code> in the menu above. This option is inactive and it does not matter what you select. It has been left for compatibility with older implementation of OTA and is targeted for removal in platform package version 2.2.0.</p>
</li>
</ul>
</li>
<li>
<p>Upload the sketch (Ctrl+U). Once done, open Serial Monitor (Ctrl+Shift+M) and check if module has joined your Wi-Fi network:</p>
<p><img alt="check if module joined network" src="../images/a-ota-upload-complete-and-joined-wifi.png" /></p>
</li>
<li>
<p>Only if module is connected to network, after a couple of seconds, the esp8266-ota port will show up in Arduino IDE. Select port with IP adress shown in Serial Monitor in previus step:</p>
<p><img alt="selection of OTA port" src="../images/a-ota-ota-port-selection.png" /></p>
<p><strong>Note:</strong> If OTA port does not show up, exit Arduino IDE, open it again and check if port is there. If it does not help check your firewall settings.</p>
</li>
<li>
<p>Now get ready for your first OTA upload by selecting the OTA port:</p>
<p><img alt="configuration of OTA upload" src="../images/a-ota-ota-upload-configuration.png" /></p>
<p><strong>Note:</strong> The menu entry  <code>Upload Speed:</code> does not matter at this point as it concerns the serial port. Just left it unchanged.</p>
</li>
<li>
<p>If you have successfully completed all the above steps, you can upload (Ctrl+U) the same (or any other) sketch over OTA:</p>
<p><img alt="OTA upload complete" src="../images/a-ota-ota-upload-complete.png" /></p>
</li>
</ol>
<p><strong>Note:</strong> To be able to upload your sketch over and over again using OTA, you need to embed OTA routines inside. Please use BasicOTA.ino as an example.</p>
<h4 id="password-protection">Password Protection<a class="headerlink" href="#password-protection" title="Permanent link">#</a></h4>
<p>Protecting your OTA uploads with password is really straightforward. All you need to do, is to include the following statement in your code:</p>
<pre class="code"><code class="language-cpp">ArduinoOTA.setPassword((const char *)&quot;123&quot;);</code></pre>


<p>Where <code>123</code> is a sample password that you should replace with your own.</p>
<p>Before implementing it in your sketch, it is a good idea to check how it works using <em>BasicOTA.ino</em> sketch available under <em>File &gt; Examples &gt; ArduinoOTA</em>.  Go ahead, open <em>BasicOTA.ino</em>, uncomment the above statement that is already there, and upload the sketch. To make troubleshooting easier, do not modify example sketch besides what is absolutely required. This is including original simple <code>123</code> OTA password. Then attempt to upload sketch again (using OTA). After compilation is complete, once upload is about to begin, you should see prompt for password as follows:</p>
<p><img alt="Password prompt for OTA upload" src="../images/a-ota-upload-password-prompt.png" /></p>
<p>Enter the password and upload should be initiated as usual with the only difference being <code>Authenticating...OK</code> message visible in upload log.</p>
<p><img alt=" Authenticating...OK during OTA upload" src="../a-ota-upload-password-authenticating-ok.png" /></p>
<p>You will not be prompted for a reentering the same password next time. Arduino IDE will remember it for you. You will see prompt for password only after reopening IDE, or if you change it in your sketch, upload the sketch and then try to upload it again.</p>
<p>Please note, it is possible to reveal password entered previously in Arduino IDE, if IDE has not been closed since last upload. This can be done by enabling <em>Show verbose output during: upload</em> in <em>File &gt; Preferences</em> and attempting to upload the module.</p>
<p><img alt="Verbose upload output with password passing in plan text" src="../images/a-ota-upload-password-passing-upload-ok.png" /></p>
<p>The picture above shows that the password is visible in log as it is passed to <em>espota.py</em> upload script.</p>
<p>Another example below shows situation when password is changed between uploads. </p>
<p><img alt="Verbose output when OTA password has been changed between uploads" src="../images/a-ota-upload-password-passing-again-upload-ok.png" /></p>
<p>When uploading, Arduino IDE used previously entered password, so the upload failed and that has been clearly reported by IDE. Only then IDE prompted for a new password. That was entered correctly and second attempt to upload has been successful.</p>
<h4 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">#</a></h4>
<p>If OTA update fails, first step is to check for error messages that may be shown in upload window of Arduino IDE. If this is not providing any useful hints try to upload again while checking what is shown by ESP on serial port. Serial Monitor from IDE will not be useful in that case. When attempting to open it, you will likely see the following:</p>
<p><img alt="Arduino IDE network terminal window" src="../images/a-ota-network-terminal.png" /></p>
<p>This window is for Arduino Yún and not yet implemented for esp8266/Arduino. It shows up because IDE is attempting to open Serial Monitor using network port you have selected for OTA upload.</p>
<p>Instead you need an external serial monitor. If you are a Windows user check out <a href="http://www.compuphase.com/software_termite.htm">Termite</a>. This is handy, slick and simple RS232 terminal that does not impose RTS or DTR flow control. Such flow control may cause issues if you are using respective lines to toggle GPIO0 and RESET pins on ESP for upload. </p>
<p>Select COM port and baud rate on external terminal program as if you were using Arduino Serial Monitor. Please see typical settings for <a href="http://www.compuphase.com/software_termite.htm">Termite</a> below:</p>
<p><img alt="Termite settings" src="../termite-configuration.png" /></p>
<p>Then run OTA from IDE and look what is displayed on terminal. Successful <a href="#arduinoota">ArduinoOTA</a> process using BasicOTA.ino sketch looks like below (IP address depends on your network configuration):</p>
<p><img alt="OTA upload successful - output on an external serial terminal" src="../images/a-ota-external-serial-terminal-output.png" /></p>
<p>If upload fails you will likely see errors caught by the uploader, exception and the stack dump, or both. </p>
<p>The most common causes of OTA failure are as follows:
<em> not enough physical memory on the chip (e.g. ESP01 with 512K flash memory is not enough for OTA),
</em> too much memory declared for SPIFFS so new sketch will not fit between existing sketch and SPIFFS – see  <a href="#update-process---memory-view">Update process - memory view</a>,
* too little memory declared in Arduino IDE for your selected board (i.e. less than physical size). </p>
<p>For more details regarding flash memory layout please check <a href="https://github.com/esp8266/Arduino/blob/master/doc/filesystem.md">File system</a>.
For overview where new sketch is stored, how it is copied and how memory is organized for the purpose of OTA see <a href="#update-process---memory-view">Update process - memory view</a>.</p>
<h2 id="web-browser">Web Browser<a class="headerlink" href="#web-browser" title="Permanent link">#</a></h2>
<p>Updates described in this chapter are done with a web browser that can be useful in the following typical scenarios:</p>
<ul>
<li>after application deployment if loading directly from Arduino IDE is inconvenient or not possible</li>
<li>after deployment if user is unable to expose module for OTA from external update server</li>
<li>to provide updates after deployment to small quantity of modules when setting an update server is not practicable</li>
</ul>
<h3 id="requirements_1">Requirements<a class="headerlink" href="#requirements_1" title="Permanent link">#</a></h3>
<ul>
<li>The ESP and the computer must be connected to the same network.</li>
</ul>
<h3 id="implementation-overview">Implementation Overview<a class="headerlink" href="#implementation-overview" title="Permanent link">#</a></h3>
<p>Updates with a web browser are implemented using <code>ESP8266HTTPUpdateServer</code> class together with <code>ESP8266WebServer</code> and <code>ESP8266mDNS</code> classes. The following code is required to get it work:</p>
<p>setup()</p>
<pre class="code"><code class="language-cpp">    MDNS.begin(host);

    httpUpdater.setup(&amp;httpServer);
    httpServer.begin();

    MDNS.addService(&quot;http&quot;, &quot;tcp&quot;, 80);</code></pre>


<p>loop()</p>
<pre class="code"><code class="language-cpp">    httpServer.handleClient();</code></pre>


<h3 id="application-example_1">Application Example<a class="headerlink" href="#application-example_1" title="Permanent link">#</a></h3>
<p>The sample implementation provided below has been done using:</p>
<ul>
<li>example sketch WebUpdater.ino available in <code>ESP8266HTTPUpdateServer</code> library</li>
<li>NodeMCU 1.0 (ESP-12E Module)</li>
</ul>
<p>You can use another module if it meets previously desribed <a href="#basic-requirements">requirements</a>.</p>
<ol>
<li>
<p>Before you begin, please make sure that you have the following software installed:</p>
<ul>
<li>Arduino IDE and 2.0.0-rc1 (of Nov 17, 2015) version of platform package as described under https://github.com/esp8266/Arduino#installing-with-boards-manager</li>
<li>Host software depending on O/S you use:<ol>
<li>Avahi http://avahi.org/ for Linux</li>
<li>Bonjour http://www.apple.com/support/bonjour/ for Windows</li>
<li>Mac OSX and iOS - support is already built in / no any extra s/w is required</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Prepare the sketch and configuration for initial upload with a serial port.</p>
<ul>
<li>Start Arduino IDE and load sketch WebUpdater.ino available under File &gt; Examples &gt; ESP8266HTTPUpdateServer.</li>
<li>Update SSID and password in the sketch so the module can join your Wi-Fi network.</li>
<li>
<p>Open File &gt; Preferences, look for “Show verbose output during:” and check out “compilation” option.</p>
<p><img alt="Preferences - enabling verbose output during compilation" src="../images/ota-web-show-verbose-compilation.png" /></p>
<p><strong>Note:</strong> This setting will be required in step 5 below. You can uncheck this setting afterwards.</p>
</li>
</ul>
</li>
<li>
<p>Upload sketch (Ctrl+U). Once done open Serial Monitor (Ctrl+Shift+M) and check if you see the following message displayed, that contains url for OTA update.</p>
<p><img alt="Serial Monitor - after first load using serial" src="../images/ota-web-serial-monitor-ready.png" /></p>
<p><strong>Note:</strong> Such message will be shown only after module successfully joins network and is ready for an OTA upload.</p>
</li>
<li>
<p>Now open web browser and enter the url provided on Serial Monitor, i.e. http://esp8266-webupdate.local/update. Once entered, browser should display a form like below that has been served by your module. The form invites you to choose a file for update.</p>
<p><img alt="OTA update form in web browser" src="../images/ota-web-browser-form.png" /></p>
<p><strong>Note:</strong> If entering <code>http://esp8266-webupdate.local/update</code> does not work, try replacing <code>esp8266-webupdate</code> with module’s IP address. For example, if your module IP is <code>192.168.1.100</code> then url should be <code>http://192.168.1.100/update</code>. This workaround is useful in case the host software installed in step 2 does not work. If still nothing works and there are no clues on Serial Monitor, try to diagnose issue by opening provided url in Google Chrome, pressing F12 and checking contents of “Console” and “Network” tabs. Chrome provides some advanced logging on these tabs.</p>
</li>
<li>
<p>To obtain the file navigate to directory used by Arduino IDE to store results of compilation. You can check the path to this file in compilation log shown in IDE debug window as marked below.</p>
<p><img alt="Compilation complete - path to binary file" src="../images/ota-web-path-to-binary.png" /></p>
</li>
<li>
<p>Now press “Choose File” in web browser, go to directory identified in step 5 above, find the file “WebUpdater.cpp.bin” and upload it. If upload is successful you will see “OK” on web browser like below.</p>
<p><img alt="OTA update complete" src="../images/ota-web-browser-form-ok.png" /></p>
<p>Module will reboot that should be visible on Serial Monitor:</p>
<p><img alt="Serial Monitor - after OTA update" src="../images/ota-web-serial-monitor-reboot.png" /></p>
<p>Just after reboot you should see exactly the same message <code>HTTPUpdateServer ready! Open http:// esp8266-webupdate.local /update in your browser</code> like in step 3. This is because module has been loaded again with the same code – first using serial port, and then using OTA.</p>
</li>
</ol>
<p>Once you are comfortable with this procedure go ahead and modify WebUpdater.ino sketch to print some additional messages, compile it, locate new binary file and upload it using web browser to see entered changes on a Serial Monitor.</p>
<p>You can also add OTA routines to your own sketch following guidelines in <a href="#implementation-overview">Implementation Overview</a> above. If this is done correctly you should be always able to upload new sketch over the previous one using a web browser.</p>
<p>In case OTA update fails dead after entering modifications in your sketch, you can always recover module by loading it over a serial port. Then diagnose the issue with sketch using Serial Monitor. Once the issue is fixed try OTA again.</p>
<h2 id="http-server">HTTP Server<a class="headerlink" href="#http-server" title="Permanent link">#</a></h2>
<p><code>ESPhttpUpdate</code> class can check for updates and download a binary file from HTTP web server.
It is possible to download updates from every IP or domain address on the network or Internet.</p>
<h4 id="requirements_2">Requirements<a class="headerlink" href="#requirements_2" title="Permanent link">#</a></h4>
<ul>
<li>web server</li>
</ul>
<h4 id="arduino-code">Arduino code<a class="headerlink" href="#arduino-code" title="Permanent link">#</a></h4>
<h5 id="simple-updater">Simple updater<a class="headerlink" href="#simple-updater" title="Permanent link">#</a></h5>
<p>Simple updater downloads the file every time the function is called.</p>
<pre class="code"><code class="language-cpp">ESPhttpUpdate.update(&quot;192.168.0.2&quot;, 80, &quot;/arduino.bin&quot;);</code></pre>


<h5 id="advanced-updater">Advanced updater<a class="headerlink" href="#advanced-updater" title="Permanent link">#</a></h5>
<p>Its possible to point update function to a script at the server.
If version string argument is given, it will be sent to the server.
Server side script can use this to check if update should be performed.</p>
<p>Server side script can respond as follows:
- response code 200, and send the firmware image,
- or response code 304 to notify ESP that no update is required.</p>
<pre class="code"><code class="language-cpp">t_httpUpdate_return ret = ESPhttpUpdate.update(&quot;192.168.0.2&quot;, 80, &quot;/esp/update/arduino.php&quot;, &quot;optional current version string here&quot;);
switch(ret) {
    case HTTP_UPDATE_FAILED:
        Serial.println(&quot;[update] Update failed.&quot;);
        break;
    case HTTP_UPDATE_NO_UPDATES:
        Serial.println(&quot;[update] Update no Update.&quot;);
        break;
    case HTTP_UPDATE_OK:
        Serial.println(&quot;[update] Update ok.&quot;); // may not called we reboot the ESP
        break;
}</code></pre>


<h4 id="server-request-handling">Server request handling<a class="headerlink" href="#server-request-handling" title="Permanent link">#</a></h4>
<h5 id="simple-updater_1">Simple updater<a class="headerlink" href="#simple-updater_1" title="Permanent link">#</a></h5>
<p>For the simple updater the server only needs to deliver the binary file for update.</p>
<h5 id="advanced-updater_1">Advanced updater<a class="headerlink" href="#advanced-updater_1" title="Permanent link">#</a></h5>
<p>For advanced update management a script needs to run at the server side, for example a PHP script.
At every update request the ESP sends some information in HTTP headers to the server.</p>
<p>Example header data:</p>
<pre class="code"><code>    [HTTP_USER_AGENT] =&gt; ESP8266-http-Update
    [HTTP_X_ESP8266_STA_MAC] =&gt; 18:FE:AA:AA:AA:AA
    [HTTP_X_ESP8266_AP_MAC] =&gt; 1A:FE:AA:AA:AA:AA
    [HTTP_X_ESP8266_FREE_SPACE] =&gt; 671744
    [HTTP_X_ESP8266_SKETCH_SIZE] =&gt; 373940
    [HTTP_X_ESP8266_SKETCH_MD5] =&gt; a56f8ef78a0bebd812f62067daf1408a
    [HTTP_X_ESP8266_CHIP_SIZE] =&gt; 4194304
    [HTTP_X_ESP8266_SDK_VERSION] =&gt; 1.3.0
    [HTTP_X_ESP8266_VERSION] =&gt; DOOR-7-g14f53a19</code></pre>


<p>With this information the script now can check if an update is needed. It is also possible to deliver different binaries based on the MAC address for example.</p>
<p>Script example:</p>
<pre class="code"><code class="language-php">&lt;?PHP

header('Content-type: text/plain; charset=utf8', true);

function check_header($name, $value = false) {
    if(!isset($_SERVER[$name])) {
        return false;
    }
    if($value &amp;&amp; $_SERVER[$name] != $value) {
        return false;
    }
    return true;
}

function sendFile($path) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 200 OK', true, 200);
    header('Content-Type: application/octet-stream', true);
    header('Content-Disposition: attachment; filename='.basename($path));
    header('Content-Length: '.filesize($path), true);
    header('x-MD5: '.md5_file($path), true);
    readfile($path);
}

if(!check_header('HTTP_USER_AGENT', 'ESP8266-http-Update')) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 403 Forbidden', true, 403);
    echo &quot;only for ESP8266 updater!\n&quot;;
    exit();
}

if(
    !check_header('HTTP_X_ESP8266_STA_MAC') ||
    !check_header('HTTP_X_ESP8266_AP_MAC') ||
    !check_header('HTTP_X_ESP8266_FREE_SPACE') ||
    !check_header('HTTP_X_ESP8266_SKETCH_SIZE') ||
    !check_header('HTTP_X_ESP8266_SKETCH_MD5') ||
    !check_header('HTTP_X_ESP8266_CHIP_SIZE') ||
    !check_header('HTTP_X_ESP8266_SDK_VERSION')
) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 403 Forbidden', true, 403);
    echo &quot;only for ESP8266 updater! (header)\n&quot;;
    exit();
}

$db = array(
    &quot;18:FE:AA:AA:AA:AA&quot; =&gt; &quot;DOOR-7-g14f53a19&quot;,
    &quot;18:FE:AA:AA:AA:BB&quot; =&gt; &quot;TEMP-1.0.0&quot;
);

if(!isset($db[$_SERVER['HTTP_X_ESP8266_STA_MAC']])) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 500 ESP MAC not configured for updates', true, 500);
}

$localBinary = &quot;./bin/&quot;.$db[$_SERVER['HTTP_X_ESP8266_STA_MAC']].&quot;.bin&quot;;

// Check if version has been set and does not match, if not, check if
// MD5 hash between local binary and ESP8266 binary do not match if not.
// then no update has been found.
if((!check_header('HTTP_X_ESP8266_SDK_VERSION') &amp;&amp; $db[$_SERVER['HTTP_X_ESP8266_STA_MAC']] != $_SERVER['HTTP_X_ESP8266_VERSION'])
    || $_SERVER[&quot;HTTP_X_ESP8266_SKETCH_MD5&quot;] != md5_file($localBinary)) {
    sendFile($localBinary);
} else {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 304 Not Modified', true, 304);
}

header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 500 no version for ESP MAC', true, 500);</code></pre>


<h2 id="stream-interface">Stream Interface<a class="headerlink" href="#stream-interface" title="Permanent link">#</a></h2>
<p>TODO describe Stream Interface</p>
<p>The Stream Interface is the base for all other update modes like OTA, http Server / client.</p>
<h2 id="updater-class">Updater class<a class="headerlink" href="#updater-class" title="Permanent link">#</a></h2>
<p>Updater is in the Core and deals with writing the firmware to the flash, 
checking its integrity and telling the bootloader to load the new firmware on the next boot.</p>
<h3 id="update-process-memory-view">Update process - memory view<a class="headerlink" href="#update-process-memory-view" title="Permanent link">#</a></h3>
<ul>
<li>The new sketch will be stored in the space between the old sketch and the spiff.</li>
<li>on the next reboot the &ldquo;eboot&rdquo; bootloader check for commands.</li>
<li>the new sketch is now copied &ldquo;over&rdquo; the old one.</li>
<li>the new sketch is started.</li>
</ul>
<p><img alt="Memory Copy" src="../update_memory_copy.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../arduino-esp8266-hardware/" class="btn btn-neutral float-right" title="Phần cứng hỗ trợ">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../filesystem/flash-layout/" class="btn btn-neutral" title="Flash Layout"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://esp8266.vn">ESP8266 Viet Nam</a></p>
    
  </div>

  
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<!-- <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/esp8266vn/esp8266.vn" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../filesystem/flash-layout/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../arduino-esp8266-hardware/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div> -->

<script type="text/javascript">
  // If cookie is defined toggle the id
  if (typeof $.cookie('docToggle') !== 'undefined') {
      // Parse cookie which is an array
      var _parsed_cookie = JSON.parse($.cookie('docToggle'));
      // Loop over array and show hidden divs
      $.each(_parsed_cookie, function(index, value) {
          // Toggle
          $("[id='hidden_" + value + "']").css('display','');
      })
  }
</script>

</body>
</html>