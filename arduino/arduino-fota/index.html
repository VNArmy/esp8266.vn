<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Tuan PM">
  
  <title>Cập nhật Firmware (FOTA) - Internet Of Things (IoT) với ESP8266</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  <link rel="stylesheet" href="../../css/custom.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Cập nhật Firmware (FOTA)";
    var mkdocs_page_input_path = "arduino/arduino-fota.md";
    var mkdocs_page_url = "/arduino/arduino-fota/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script>
  <script src="../../js/jquery.cookie-1.4.1.min.js"></script>
  <script src="../../js/nav.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60470603-4', 'esp8266.vn');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Internet Of Things (IoT) với ESP8266</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../.." id="Trang chủ" style="font-size:95%;font-weight:bold;">Trang chủ</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="current">
        <a class="current"  id="Nội dung" style="font-size:95%;font-weight:bold;">Nội dung</a>
    </li>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="Kiến thức cơ bản" onclick="showChildren('Kiến thức cơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> Kiến thức cơ bản</a>
        </li>
        
        <div style="display:none" id="hidden_Kiến thức cơ bản">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/introduction/" id="Tổng quan">  Tổng quan </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quan">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/about-iot/" id="Internet Of Things (IoT)">  Internet Of Things (IoT) </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/about-esp8266/" id="ESP8266 & ESP8285">  ESP8266 & ESP8285 </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/esp-module/" id="Module & Board phát triển">  Module & Board phát triển </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285Module & Board phát triển">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../introduction/prepare/" id="Phần cứng & công cụ">  Phần cứng & công cụ </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quanInternet Of Things (IoT)ESP8266 & ESP8285Module & Board phát triểnPhần cứng & công cụ">
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 NONOS-SDK" onclick="showChildren('ESP8266 NONOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 NONOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 NONOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../nonos-sdk/nonos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/basic/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/compile-first-time/" id="Biên dịch dự án mẫu">Biên dịch dự án mẫu </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/blink-led/" id="Bật tắt LED">Bật tắt LED </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/button/" id="Nút nhấn">Nút nhấn </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/uart/" id="UART">UART </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/complex-makefile/" id="Makefile cho dự án phức tạp">Makefile cho dự án phức tạp </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/task/" id="Task">Task </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/wifi/" id="Wifi">Wifi </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/espconn/" id="ESPCONN">ESPCONN </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/mdns/" id="MDNS">MDNS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/ntp/" id="NTP">NTP </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/basic/save-to-flash/" id="Lưu dữ liệu vào Flash">Lưu dữ liệu vào Flash </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Smartconfig" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfig')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Smartconfig </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfig">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/smartconfig/" id="ESP8266 Smartconfig">ESP8266 Smartconfig </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/why-smartconfig/" id="Tại sao cần Smartconfig">Tại sao cần Smartconfig </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/esptouch/" id="ESPTOUCH & AIRKISS">ESPTOUCH & AIRKISS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/smartconfig/wps/" id="WPS">WPS </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="MQTT" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTT')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  MQTT </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTT">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/mqtt/what-is-mqtt/" id="Giao thức MQTT">Giao thức MQTT </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/mqtt/mqtt-client/" id="ESP8266 MQTT Client">ESP8266 MQTT Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Client" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP Client')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Client </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP Client">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/http-client/http-client/" id="ESP8266 HTTP Client">ESP8266 HTTP Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Server" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP Server')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Server </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP Server">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/http-server/http-server/" id="ESP8266 HTTP Server">ESP8266 HTTP Server </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Firmware Over The Air" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The Air')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Firmware Over The Air </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The Air">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/fota/fota/" id="FOTA">FOTA </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Now" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP Now')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Now </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP Now">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/esp-now/esp-now/" id="ESP Now">ESP Now </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Mesh" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP Mesh')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Mesh </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP Mesh">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/esp-mesh/esp-mesh/" id="ESP Mesh">ESP Mesh </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Các dự án" onclick="showChildren('ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP MeshCác dự án')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Các dự án </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệuCơ bảnSmartconfigMQTTHTTP ClientHTTP ServerFirmware Over The AirESP NowESP MeshCác dự án">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../nonos-sdk/projects/list/" id="Danh sách">Danh sách </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 FreeRTOS-SDK" onclick="showChildren('ESP8266 FreeRTOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 FreeRTOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../freertos-sdk/freertos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 FreeRTOS-SDKGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../freertos-sdk/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="current">
            <a style="padding-left:50px;" class="current"  id="ESP8266 Arduino" onclick="showChildren('ESP8266 Arduino')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Arduino</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Arduino">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../arduino/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/install/" id="Cài đặt">Cài đặt </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/digital/" id="Digital">Digital </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/analog/" id="Analog">Analog </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/timming-delay/" id="Thời gian & Delay">Thời gian & Delay </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/serial/" id="Serial">Serial </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../basic/progmem/" id="Progmem">Progmem </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Thư viện" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư viện')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Thư viện </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư viện">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../libraries/esp8266-wifi/" id="ESP8266WiFi">ESP8266WiFi </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Filesystem" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystem')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Filesystem </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystem">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../filesystem/flash-layout/" id="Flash Layout">Flash Layout </a>
                </li>
            
            </div>
        
            <li class="current">
                <a style="padding-left:70px;" class="current" href="./" id="Cập nhật Firmware (FOTA)">  Cập nhật Firmware (FOTA) </a>
                <!-- 
                    <ul>
                    
                        <li class="toctree-l3"><a href="#gioi-thieu-ota">Giới thiệu OTA</a></li>
                        
                            <li><a class="toctree-l4" href="#bao-mat">Bảo mật</a></li>
                        
                            <li><a class="toctree-l4" href="#an-toan">An toàn</a></li>
                        
                            <li><a class="toctree-l4" href="#yeu-cau-co-ban">Yêu cầu cơ bản</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#arduino-ide">Arduino IDE</a></li>
                        
                            <li><a class="toctree-l4" href="#yeu-cau">Yêu cầu</a></li>
                        
                            <li><a class="toctree-l4" href="#vi-du-ung-dung">Ví dụ ứng dụng</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#trinh-duyet-web">Trình duyệt Web</a></li>
                        
                            <li><a class="toctree-l4" href="#requirements">Requirements</a></li>
                        
                            <li><a class="toctree-l4" href="#implementation-overview">Implementation Overview</a></li>
                        
                            <li><a class="toctree-l4" href="#application-example">Application Example</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#http-server">HTTP Server</a></li>
                        
                            <li><a class="toctree-l4" href="#requirements_1">Requirements</a></li>
                        
                            <li><a class="toctree-l4" href="#arduino-code">Arduino code</a></li>
                        
                            <li><a class="toctree-l4" href="#server-request-handling">Server request handling</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#stream-interface">Stream Interface</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#updater-class">Updater class</a></li>
                        
                            <li><a class="toctree-l4" href="#update-process-memory-view">Update process - memory view</a></li>
                        
                    
                    </ul>
                 -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../arduino-esp8266-hardware/" id="Phần cứng hỗ trợ">  Phần cứng hỗ trợ </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợ">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Các dự án" onclick="showChildren('ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợCác dự án')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Các dự án </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệuCơ bảnThư việnFilesystemCập nhật Firmware (FOTA)Phần cứng hỗ trợCác dự án">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../projects/list/" id="Danh sách">Danh sách </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 Micropython" onclick="showChildren('ESP8266 Micropython')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Micropython</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Micropython">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../micropython/micropython/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 MicropythonGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../micropython/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
            </div>
        
        </div>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../projects/list/" id="Các dự án" style="font-size:95%;font-weight:bold;">Các dự án</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../license/" id="Bản quyền" style="font-size:95%;font-weight:bold;">Bản quyền</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../contributor/" id="Đóng góp" style="font-size:95%;font-weight:bold;">Đóng góp</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Internet Of Things (IoT) với ESP8266</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Nội dung &raquo;</li>
        
      
        
          <li>ESP8266 Arduino &raquo;</li>
        
      
    
    <li>Cập nhật Firmware (FOTA)</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/esp8266vn/esp8266.vn" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc">
<ul>
<li><a href="#gioi-thieu-ota">Giới thiệu OTA</a><ul>
<li><a href="#bao-mat">Bảo mật</a></li>
<li><a href="#an-toan">An toàn</a></li>
<li><a href="#yeu-cau-co-ban">Yêu cầu cơ bản</a></li>
</ul>
</li>
<li><a href="#arduino-ide">Arduino IDE</a><ul>
<li><a href="#yeu-cau">Yêu cầu</a></li>
<li><a href="#vi-du-ung-dung">Ví dụ ứng dụng</a><ul>
<li><a href="#bao-ve-mat-khau">Bảo vệ mật khẩu</a></li>
<li><a href="#giai-quyet-cac-loi-thuong-gap">Giải quyết các lỗi thường gặp</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#trinh-duyet-web">Trình duyệt Web</a><ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#implementation-overview">Implementation Overview</a></li>
<li><a href="#application-example">Application Example</a></li>
</ul>
</li>
<li><a href="#http-server">HTTP Server</a><ul>
<li><a href="#requirements_1">Requirements</a></li>
<li><a href="#arduino-code">Arduino code</a><ul>
<li><a href="#simple-updater">Simple updater</a></li>
<li><a href="#advanced-updater">Advanced updater</a></li>
</ul>
</li>
<li><a href="#server-request-handling">Server request handling</a><ul>
<li><a href="#simple-updater_1">Simple updater</a></li>
<li><a href="#advanced-updater_1">Advanced updater</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#stream-interface">Stream Interface</a></li>
<li><a href="#updater-class">Updater class</a><ul>
<li><a href="#update-process-memory-view">Update process - memory view</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="gioi-thieu-ota">Giới thiệu OTA<a class="headerlink" href="#gioi-thieu-ota" title="Permanent link">#</a></h2>
<p>Cập nhật firmware OTA (Over the Air) là tiến trình tải firmware mới vào ESP module thay vì sử dụng cổng Serial. Tính năng này thực sự rất hữu dụng trong nhiều trường hợp giới hạn về kết nối vật lý đến ESP Module.</p>
<p>OTA có thể thực hiện với:</p>
<ul>
<li><a href="#arduino-ide">Arduino IDE</a></li>
<li><a href="#web-browser">Web Browser</a></li>
<li><a href="#http-server">HTTP Server</a></li>
</ul>
<p>Sử dụng OTA với tùy chọn dùng <strong>Arduino IDE</strong> trong quá trình phát triển, thử nghiệm, 2 tùy chọn còn lại phù hợp cho việc triển khai ứng dụng thực tế, cung cấp tính năng cập nhật OTA thông qua web hay sử dụng HTTP Server.</p>
<p>Trong tất cả các trường hợp, thì Firmware hỗ trợ OTA phải được nạp lần đầu tiên qua cổng Serial, nếu mọi thứ hoạt động trơn tru, logic ứng dụng OTA hoạt động đúng thì có thể thực hiện việc cập nhật firmware thông qua OTA.</p>
<p>Sẽ không có đảm bảo an ninh đối với quá trình cập nhật OTA bị hack. Nó phụ thuộc vào nhà phát triển đảm bảo việc cập nhật được phép từ nguồn hợp pháp, đáng tin cậy. Khi cập nhật hoàn tấn, ESP8266 sẽ khởi động lại và thực thi code mới. Nhà phát triển phải đảm bảo ứng dụng thực trên module phải được tắt và khởi độn glaij 1 cách an toàn. Nội dung bên dưới cung cấp bổ sung các thông tin về an ninh, và an toàn cho tiến trình cập nhật OTA.</p>
<h3 id="bao-mat">Bảo mật<a class="headerlink" href="#bao-mat" title="Permanent link">#</a></h3>
<p>Khi ESP8266  được phép thực thi OTA, có nghĩa nó được kết nối mạng không dây và có khả năng được cập nhập Sketch mới. Cho nên khả năng ESP8266 bị tấn công sẽ nhiều hơn và bị nạp bởi mã thực thi khác là rất cao. Để giảm khả năng bị tấn công cần xem xét bảo vệ cập nhật của bạn với một mật khẩu, cổng sử dụng cố định khác biệt, v.v&hellip;</p>
<p>Kiểm tra những tính năng được cung cấp bởi thư viện <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> thường xuyên, có thể được nâng cấp khả năng bảo vệ an toàn:</p>
<pre><code class="cpp">void setPort(uint16_t port);
void setHostname(const char* hostname);
void setPassword(const char* password);
</code></pre>

<p>Một số chức năng bảo vệ đã được xây dựng trong và không yêu cầu bất kỳ mã hóa nào cho nhà phát triển. <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> và <code>espota.py</code> sử dụng <a href="https://en.wikipedia.org/wiki/Digest_access_authentication">Digest-MD5</a> để chứng thực việc tải firmware lên. Đơn giản là đảm bảo tính toàn vẹn của firmware bằng việc tính <a href="https://en.wikipedia.org/wiki/MD5">MD5</a>.</p>
<p>Hãy phân tích rủi ro cho riêng ứng dụng của bạn bạn và tùy thuộc vào ứng dụng mà quyết định những chức năng cũng như thư viện để thực hiện. Nếu cần thiết, có thẻ xem xét việc thực hiện các phương thức bảo vệ khỏi bị hack, ví dụ như cập nhật OTA chỉ cho tải lên chỉ theo lịch trình cụ thể, kích hoạt OTA chỉ được người dùng nhấn nút chuyên dụng &ldquo;Cập nhật&rdquo;, v.v&hellip;</p>
<h3 id="an-toan">An toàn<a class="headerlink" href="#an-toan" title="Permanent link">#</a></h3>
<p>Quá trình OTA tiêu tốn nguồn tài nguyên và băng thông của ESP8266 khi tải lên. Sau đó, ESP8266 được khởi động lại và một Sketch mới được thực thi. Cần phải phân tích và kiểm tra để Sketch mới không ảnh hưởng tới các chức năng hiện có của Sketch hiện tại, cũng như việc cập nhật OTA lần sau vẫn được đảm bảo.</p>
<p>Nếu ESP8266 được đặt từ xa và kiểm soát một số thiết bị đang vận hành, bạn nên đặt các chú ý đi kèm thông tin những gì sẽ xảy ra nếu hoạt động của thiết bị này đột nhiên bị gián đoạn bởi quá trình cập nhật. Vần phải đưa thiết bị vào trạng thái an toàn trước khi bắt đầu cập nhật. 
Ví dụ ESP8266 của bạn có thể được kiểm soát một hệ thống tưới vườn. Nếu nó không được đóng đúng cách và một van nước bỏ ngỏ, khu vườn của bạn có thể bị ngập và van này không được đóng lại sau khi OTA xong và khởi động lại mô-đun.</p>
<p>Một số hàm sau được cung cấp kèm với thưu viện <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> và được dùng để xử lý các chức năng của ứng dụng trong từng giai đoạn cụ thể của OTA hoặc xử lý lỗi OTA:</p>
<pre><code class="cpp">void onStart(OTA_CALLBACK(fn));
void onEnd(OTA_CALLBACK(fn));
void onProgress(OTA_CALLBACK_PROGRESS(fn));
void onError(OTA_CALLBACK_ERROR (fn));
</code></pre>

<h3 id="yeu-cau-co-ban">Yêu cầu cơ bản<a class="headerlink" href="#yeu-cau-co-ban" title="Permanent link">#</a></h3>
<p>Kích thước Flash cần đủ để có thể giữ Sketch cũ (hiện đang chạy) và Sketch mới (OTA) cùng một lúc. Xem <a href="../filesystem/flash-layout/#flash-layout">flash layout</a>.</p>
<pre><code class="cpp">ESP.getFreeSketchSpace();
</code></pre>

<p>có thể sử dụng cho việc kiểm tra vùng nhớ còn trống cho Sketch mới.</p>
<p>Để có cái nhìn tổng quan về layout bộ nhớ, nơi Sketch mới được lưu trữ và làm thế nào để ESP8266 copy trong quá trình OTA, xem ở <a href="#update-process---memory-view">Tiến trình cập nhật - bộ nhớ</a>.</p>
<p>Phần tiếp theo sẽ cung cấp thông tinh chi tiết cho từng phương thức OTA.</p>
<h2 id="arduino-ide">Arduino IDE<a class="headerlink" href="#arduino-ide" title="Permanent link">#</a></h2>
<p>Cập nhật OTA sử dụng Arduino IDE tải firmware lên cho ESP8266 dành cho các tình huống điển hình sau đây:
- Trong quá trình phát triển ứng dụng như một cách thay thế nhanh hơn sử dụng cổng Serial
- Để cập nhật số lượng nhỏ của các module ESP8266
- Chỉ khi module ESP8266 cùng mạng LAN với máy tính chạy Arduino IDE</p>
<h3 id="yeu-cau">Yêu cầu<a class="headerlink" href="#yeu-cau" title="Permanent link">#</a></h3>
<ul>
<li>Các module ESP8266 và máy tính phải được kết nối với cùng một mạng LAN.</li>
</ul>
<h3 id="vi-du-ung-dung">Ví dụ ứng dụng<a class="headerlink" href="#vi-du-ung-dung" title="Permanent link">#</a></h3>
<p>Hướng dẫn dưới đây cấu hình chương trình OTA sử dụng board NodeMCU 1.0 (ESP-12E Module). Bạn có thể sử dụng bất kỳ board ESP8266 nào, miễn sao nó đáp ứng được [yêu cầu] (#basic-requirements) được mô tả ở trên. Hướng dẫn này có hiệu lực cho tất cả các hệ điều hành hỗ trợ bởi Arduino IDE. Màn hình chụp đã được thực hiện trên Windows 7 và bạn có thể thấy sự khác biệt nhỏ (như tên của cổng nối tiếp) nếu bạn đang sử dụng Linux và MacOS.</p>
<p><strong>1.</strong> Trước khi bạn bắt đầu, bạn cần đảm bảo các phần mềm sau đã được cài đặt:
- Arduino IDE 1.6.7 hoặc mới hơn - https://www.arduino.cc/en/Main/Software
- ESP8266/Arduino nền tảng gói 2.0.0 hoặc mới hơn - để được hướng dẫn làm theo https://esp8266.vn/arduino/basic/install/
- Python 2.7 (không cài đặt Python 3.5, nó không được hỗ trợ) - https://www.python.org/</p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Người dùng Windows nên chọn &ldquo;Add python.exe Path&rdquo; (xem bên dưới - tùy chọn này không được chọn theo mặc định).</p>
</div>
<p><img alt="cài đặt Python" src="../images/a-ota-python-configuration.png" /></p>
<p><strong>2.</strong> Bây giờ chuẩn bị cho Sketch mới và cấu hình cho việc  nạp firmware qua cổng nối tiếp.
- Bắt đầu Arduino IDE và mở BasicOTA.ino Sketch sẵn, phần File &gt;  Examples &gt; ArduinoOTA
<img alt="lựa chọn các ví dụ OTA phác thảo" src="../images/a-ota-sketch-selection.png" /></p>
<ul>
<li>
<p>Cập nhật SSID và mật khẩu WiFi để ESP8266 có thể kết nối vào mạng Wi-Fi của bạn
<img alt="SSID và mật khẩu nhập" src="../images/a-ota-ssid-pass-entry.png" /></p>
</li>
<li>
<p>Các thông số cấu hình tải lên như bên dưới (bạn có thể cần phải điều chỉnh cấu hình nếu bạn đang sử dụng các module ESP8266 khác):
! [cấu hình tải lên nối tiếp] (images/a-ota-serial-upload-configuration.png)</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Tùy thuộc vào phiên bản của gói nền tảng và hội đồng quản trị mà bạn có, bạn có thể thấy <code>Upload Using:</code>  trong menu ở trên. Tùy chọn này không hoạt động và nó không quan trọng khi bạn chọn. Nó đã được để lại cho phù hợp với phiên bản cũ của OTA và sẽ bị loại bỏ trong phiên bản 2.2.0.</p>
</div>
<p><strong>3.</strong> Nạp Sketch (Ctrl + U). Sau khi thực hiện, mở tiếp Serial Monitor (Ctrl + Shift + M) và kiểm tra xem ESP8266 đã kết nối vào mạng Wi-Fi của bạn:</p>
<p><img alt="kiểm tra nếu module tham gia mạng" src="../images/a-ota-upload-complete-and-joined-wifi.png" /></p>
<p><strong>4.</strong> Chỉ khi module ESP8266 được kết nối vào mạng, sau một vài giây, cổng esp8266-ota sẽ hiển thị trong Arduino IDE. Chọn cổng với địa chỉ IP hiện tại hiển thị trên Serial Monitor trong bước trước:</p>
<p><img alt="lựa chọn các cổng OTA" src="../images/a-ota-ota-port-selection.png" /></p>
<p>!!! note &ldquo;Lưu ý&rdquo; 
    Nếu cổng OTA không hiện lên, Thoát khảoi Arduino IDE, mở nó một lần nữa và kiểm tra lại. Nếu hoàn toàn không có, thiết lập tường lửa của bạn.</p>
<p><strong>5.</strong> Bây giờ đã sẵn sàng để cập nhật OTA đầu tiên của bạn bằng cách chọn cổng OTA:</p>
<p><img alt="cấu hình tải lên OTA" src="../images/a-ota-ota-upload-configuration.png" /></p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Các mục trình đơn <code>Upload Speed:</code> không quan trọng vào thời điểm này vì nó liên quan đến cổng nối tiếp. Không cần phải tác động</p>
</div>
<p><strong>6.</strong> Nếu bạn đã hoàn thành tất cả các bước trên, bạn có thể tải lên (Ctrl + U) cùng một (hoặc bất kỳ) Sketch qua OTA:</p>
<p><img alt="OTA tải lên hoàn" src="../images/a-ota-ota-upload-complete.png" /></p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Để có thể tải lên các bản Sketch của bạn nhiều lần hơn nữa sử dụng OTA, bạn cần phải sử dụng các hàm phục vụ OTA bên trong. Vui lòng xem cách sử dụng BasicOTA.ino như là một ví dụ.</p>
</div>
<h4 id="bao-ve-mat-khau">Bảo vệ mật khẩu<a class="headerlink" href="#bao-ve-mat-khau" title="Permanent link">#</a></h4>
<p>Bảo vệ cập nhật OTA với mật khẩu khá đơn giản. Tất cả việc cần làm là sử dụng đoạn code sau trong mã Sketch:</p>
<pre><code class="cpp">ArduinoOTA.setPassword ((const char *) &quot;123&quot;);
</code></pre>

<p>Với <code>123</code> là một mật khẩu mẫu cần được thay thế cho ứng dụng của bạn.</p>
<p>Trước khi thực hiện nó trong Sketch, Bạn có thể thử nghiệm hoạt động OTA bằng việc mở Sketch mẫu <strong>BasicOTA.ino</strong> trong <strong>File &gt; Examples &gt; ArduinoOTA</strong>.  Tiếp theo, mở <strong>BasicOTA.ino</strong>, bỏ comment phía trước phần cấu hình mật khầu (mô tả bên trên). Để xử lý các trường hợp lỗi dễ dàng hơn, không nên sửa đổi mẫu Sketch ngoài trừ các yêu cầu cần thiết. Bao gồm việc đơn giản là sửa mật khẩu OTA <code>123</code>  thành mật khẩu của bạn. Rồi cập nhật lên ứng dụng sử dụng OTA. Khi bạn bắt đầu cập nhật OTA, sẽ hiện ra khung hỏi mật khẩu như bên dưới:</p>
<p><img alt="Mật khẩu nhắc để tải lên OTA" src="../images/a-ota-upload-password-prompt.png" /></p>
<p>Nhập mật khẩu và tải lên nên bắt đầu như bình thường, chỉ khác lúc trước là có thêm dòng <code>Authenticating ...OK</code> trong cửa sổ log.</p>
<p><img alt=" Xác thực ...OK trong upload OTA" src="../images/a-ota-upload-password-authenticating-ok.png" /></p>
<p>Bạn sẽ không bị hỏi mật khảu cho lần sau. Arduino IDE sẽ nhớ nó cho bạn. Bạn chỉ thấy dấu khung hỏi mật khẩu chỉ khi mở lại IDE, hoặc nếu bạn thay đổi nó trong Sketch của bạn, tải lên các bản phác thảo và sau đó tải nó lên một lần nữa.</p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Hoàn toàn có khả năng xem lại mật khẩu của lần cập nhật trước bởi Arduino IDE, nếu IDE không bị đóng kể từ lần cập nhật sau cùng. Để thấy được mật khẩu trong cửa sổ Log, thực hiện như sau: Cho phép <em>Show verbose output during: upload</em> trong <em>File &gt; Preferences</em> và thực hiện việc cập nhật lại.</p>
</div>
<p><img alt="Verbose upload output with password passing in plan text" src="../images/a-ota-upload-password-passing-upload-ok.png" /></p>
<p>Hình ảnh trên cho thấy mật khẩu là có thể được nhìn thấy trong Log và nó được gán cho file <strong>espota.py</strong> để thực hiện việc tải firmware.</p>
<p>Ví dụ dưới đây cho thấy tình huống khi mật khẩu được thay đổi giữa các lần cập nhật. </p>
<p><img alt="đầu ra dài khi OTA mật khẩu đã được thay đổi giữa các lần tải" src="../images/a-ota-upload-password-passing-again-upload-ok.png" /></p>
<p>Khi thực hiện cập nhật, Arduino IDE sử dụng mật khẩu đã nhập trước đó, vì vậy khi không thành công và sẽ báo cáo rõ ràng bởi IDE, IDE sẽ nhắc bạn nhập mật khẩu mới và dùng nó để thực hiện lại việc cập nhật, để đảm bảo thành công.</p>
<h4 id="giai-quyet-cac-loi-thuong-gap">Giải quyết các lỗi thường gặp<a class="headerlink" href="#giai-quyet-cac-loi-thuong-gap" title="Permanent link">#</a></h4>
<p>Nếu OTA cập nhật thất bại, bước đầu tiên là kiểm tra các thông báo lỗi được hiển thị trong cửa sổ Log của Arduino IDE. Nếu nó không được cung cấp được bất kỳ gợi ý hữu ích nào, thử cập nhật OTA một lần nữa trong khi kiểm tra thông tin từ ESP8266 được thể hiện trên cổng Serial. Serial Port Monitor từ IDE sẽ không hữu ích trong trường hợp đó. Khi cố gắng để mở nó, bạn có thể sẽ thấy như sau:</p>
<p><img alt="Arduino IDE cửa sổ thiết bị đầu cuối mạng" src="../images/a-ota-network-terminal.png" /></p>
<p>Cửa sổ này là dành cho Arduino Yun và chưa nâng cấp cho esp8266/Arduino. Nó hiển thị bởi vì IDE đang cố mở tiếp sổ Serial Monitor sử dụng cổng Network mà bạn đã chọn để tải lên OTA.</p>
<p>Thay vào đó bạn cần một chương trình Serial Port Monitor  bên ngoài. Nếu bạn là người dùng Windows, hãy xem qua <a href="http://www.compuphase.com/software_termite.htm">Termite</a>. Khá tiện dụng, thú vị và đơn giản, sử dụng cho thiết bị đầu cuối RS232 mà không áp đặt điều khiển flow control RTS hoặc DTR. Việc sử dụng flow control cho cổng Serial có thể gây ra vấn đề chuyển mức tín hiệu GPIO0 và RESET chân trên ESP8266. </p>
<p>Chọn cổng COM và tốc độ truyền trên chương trình Serial Port Monitor như khi bạn đang sử dụng Arduino Serial Monitor. Xem các thiết lập tiêu biểu cho <a href="http://www.compuphase.com/software_termite.htm">Termite</a> dưới đây:</p>
<p><img alt="thiết lập mối" src="../images/termite-configuration.png" /></p>
<p>Sau đó chạy OTA từ IDE và nhìn những gì được hiển thị trên Serial Port Terminal. Tiến tình  <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> thành công sử dụng BasicOTA.ino Sketch nhìn như bên dưới (địa chỉ IP phụ thuộc vào cấu hình mạng của bạn):</p>
<p><img alt="OTA tải lên thành công - sản lượng trên một thiết bị đầu cuối nối tiếp bên ngoài" src="../images/a-ota-external-serial-terminal-output.png" /></p>
<p>Nếu cập nhật bị lỗi bạn sẽ muốn nhìn thấy nguyên nhân bởi trình tải lên, exception và stack dump, hoặc cả 2 </p>
<p>Các nguyên nhân phổ biến nhất gây thất bại cho việc cập nhật OTA như sau:</p>
<ul>
<li>Không đủ bộ nhớ Flash trên chip (ví dụ như ESP01 với bộ nhớ flash 512K là không đủ cho OTA),</li>
<li>Định nghĩa bộ nhờ Flash quá nhiều cho SPIFFS, Sketch mới sẽ không khớp với Sketch cũ và SPIFFS - xem [Cập nhật quá trình - xem bộ nhớ] #update-process&mdash;memory-view),</li>
<li>Quá ít bộ nhớ Flash được khai báo trong Arduino IDE cho board của bạn (tức là ít hơn so với kích thước vật lý). </li>
</ul>
<p>Để biết thêm chi tiết về cách bố trí bộ nhớ flash xin vui lòng kiểm tra [Filesystem] (filesystem/flash-layout.md).
Tổng quan về nơi Sketch mới được lưu trữ, làm thế nào nó được sao chép và tổ chức  bộ nhớ cho mục đích OTA xem như thế nào, xem [Tiến trình cập nhật - Memory view] (#update-process&mdash;memory-view).</p>
<h2 id="trinh-duyet-web">Trình duyệt Web<a class="headerlink" href="#trinh-duyet-web" title="Permanent link">#</a></h2>
<p>Updates described in this chapter are done with a web browser that can be useful in the following typical scenarios:</p>
<ul>
<li>after application deployment if loading directly from Arduino IDE is inconvenient or not possible</li>
<li>after deployment if user is unable to expose module for OTA from external update server</li>
<li>to provide updates after deployment to small quantity of modules when setting an update server is not practicable</li>
</ul>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">#</a></h3>
<ul>
<li>The ESP and the computer must be connected to the same network.</li>
</ul>
<h3 id="implementation-overview">Implementation Overview<a class="headerlink" href="#implementation-overview" title="Permanent link">#</a></h3>
<p>Updates with a web browser are implemented using <code>ESP8266HTTPUpdateServer</code> class together with <code>ESP8266WebServer</code> and <code>ESP8266mDNS</code> classes. The following code is required to get it work:</p>
<p>setup()</p>
<pre><code class="cpp">    MDNS.begin(host);

    httpUpdater.setup(&amp;httpServer);
    httpServer.begin();

    MDNS.addService(&quot;http&quot;, &quot;tcp&quot;, 80);
</code></pre>

<p>loop()</p>
<pre><code class="cpp">    httpServer.handleClient();
</code></pre>

<h3 id="application-example">Application Example<a class="headerlink" href="#application-example" title="Permanent link">#</a></h3>
<p>The sample implementation provided below has been done using:</p>
<ul>
<li>example sketch WebUpdater.ino available in <code>ESP8266HTTPUpdateServer</code> library</li>
<li>NodeMCU 1.0 (ESP-12E Module)</li>
</ul>
<p>You can use another module if it meets previously desribed <a href="#basic-requirements">requirements</a>.</p>
<ol>
<li>
<p>Before you begin, please make sure that you have the following software installed:</p>
<ul>
<li>Arduino IDE and 2.0.0-rc1 (of Nov 17, 2015) version of platform package as described under https://github.com/esp8266/Arduino#installing-with-boards-manager</li>
<li>Host software depending on O/S you use:<ol>
<li>Avahi http://avahi.org/ for Linux</li>
<li>Bonjour http://www.apple.com/support/bonjour/ for Windows</li>
<li>Mac OSX and iOS - support is already built in / no any extra s/w is required</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Prepare the sketch and configuration for initial upload with a serial port.</p>
<ul>
<li>Start Arduino IDE and load sketch WebUpdater.ino available under File &gt; Examples &gt; ESP8266HTTPUpdateServer.</li>
<li>Update SSID and password in the sketch so the module can join your Wi-Fi network.</li>
<li>
<p>Open File &gt; Preferences, look for “Show verbose output during:” and check out “compilation” option.</p>
<p><img alt="Preferences - enabling verbose output during compilation" src="../images/ota-web-show-verbose-compilation.png" /></p>
<p><strong>Note:</strong> This setting will be required in step 5 below. You can uncheck this setting afterwards.</p>
</li>
</ul>
</li>
<li>
<p>Upload sketch (Ctrl+U). Once done open Serial Monitor (Ctrl+Shift+M) and check if you see the following message displayed, that contains url for OTA update.</p>
<p><img alt="Serial Monitor - after first load using serial" src="../images/ota-web-serial-monitor-ready.png" /></p>
<p><strong>Note:</strong> Such message will be shown only after module successfully joins network and is ready for an OTA upload.</p>
</li>
<li>
<p>Now open web browser and enter the url provided on Serial Monitor, i.e. http://esp8266-webupdate.local/update. Once entered, browser should display a form like below that has been served by your module. The form invites you to choose a file for update.</p>
<p><img alt="OTA update form in web browser" src="../images/ota-web-browser-form.png" /></p>
<p><strong>Note:</strong> If entering <code>http://esp8266-webupdate.local/update</code> does not work, try replacing <code>esp8266-webupdate</code> with module’s IP address. For example, if your module IP is <code>192.168.1.100</code> then url should be <code>http://192.168.1.100/update</code>. This workaround is useful in case the host software installed in step 2 does not work. If still nothing works and there are no clues on Serial Monitor, try to diagnose issue by opening provided url in Google Chrome, pressing F12 and checking contents of “Console” and “Network” tabs. Chrome provides some advanced logging on these tabs.</p>
</li>
<li>
<p>To obtain the file navigate to directory used by Arduino IDE to store results of compilation. You can check the path to this file in compilation log shown in IDE debug window as marked below.</p>
<p><img alt="Compilation complete - path to binary file" src="../images/ota-web-path-to-binary.png" /></p>
</li>
<li>
<p>Now press “Choose File” in web browser, go to directory identified in step 5 above, find the file “WebUpdater.cpp.bin” and upload it. If upload is successful you will see “OK” on web browser like below.</p>
<p><img alt="OTA update complete" src="../images/ota-web-browser-form-ok.png" /></p>
<p>Module will reboot that should be visible on Serial Monitor:</p>
<p><img alt="Serial Monitor - after OTA update" src="../images/ota-web-serial-monitor-reboot.png" /></p>
<p>Just after reboot you should see exactly the same message <code>HTTPUpdateServer ready! Open http:// esp8266-webupdate.local /update in your browser</code> like in step 3. This is because module has been loaded again with the same code – first using serial port, and then using OTA.</p>
</li>
</ol>
<p>Once you are comfortable with this procedure go ahead and modify WebUpdater.ino sketch to print some additional messages, compile it, locate new binary file and upload it using web browser to see entered changes on a Serial Monitor.</p>
<p>You can also add OTA routines to your own sketch following guidelines in <a href="#implementation-overview">Implementation Overview</a> above. If this is done correctly you should be always able to upload new sketch over the previous one using a web browser.</p>
<p>In case OTA update fails dead after entering modifications in your sketch, you can always recover module by loading it over a serial port. Then diagnose the issue with sketch using Serial Monitor. Once the issue is fixed try OTA again.</p>
<h2 id="http-server">HTTP Server<a class="headerlink" href="#http-server" title="Permanent link">#</a></h2>
<p><code>ESPhttpUpdate</code> class can check for updates and download a binary file from HTTP web server.
It is possible to download updates from every IP or domain address on the network or Internet.</p>
<h4 id="requirements_1">Requirements<a class="headerlink" href="#requirements_1" title="Permanent link">#</a></h4>
<ul>
<li>web server</li>
</ul>
<h4 id="arduino-code">Arduino code<a class="headerlink" href="#arduino-code" title="Permanent link">#</a></h4>
<h5 id="simple-updater">Simple updater<a class="headerlink" href="#simple-updater" title="Permanent link">#</a></h5>
<p>Simple updater downloads the file every time the function is called.</p>
<pre><code class="cpp">ESPhttpUpdate.update(&quot;192.168.0.2&quot;, 80, &quot;/arduino.bin&quot;);
</code></pre>

<h5 id="advanced-updater">Advanced updater<a class="headerlink" href="#advanced-updater" title="Permanent link">#</a></h5>
<p>Its possible to point update function to a script at the server.
If version string argument is given, it will be sent to the server.
Server side script can use this to check if update should be performed.</p>
<p>Server side script can respond as follows:
- response code 200, and send the firmware image,
- or response code 304 to notify ESP that no update is required.</p>
<pre><code class="cpp">t_httpUpdate_return ret = ESPhttpUpdate.update(&quot;192.168.0.2&quot;, 80, &quot;/esp/update/arduino.php&quot;, &quot;optional current version string here&quot;);
switch(ret) {
    case HTTP_UPDATE_FAILED:
        Serial.println(&quot;[update] Update failed.&quot;);
        break;
    case HTTP_UPDATE_NO_UPDATES:
        Serial.println(&quot;[update] Update no Update.&quot;);
        break;
    case HTTP_UPDATE_OK:
        Serial.println(&quot;[update] Update ok.&quot;); // may not called we reboot the ESP
        break;
}
</code></pre>

<h4 id="server-request-handling">Server request handling<a class="headerlink" href="#server-request-handling" title="Permanent link">#</a></h4>
<h5 id="simple-updater_1">Simple updater<a class="headerlink" href="#simple-updater_1" title="Permanent link">#</a></h5>
<p>For the simple updater the server only needs to deliver the binary file for update.</p>
<h5 id="advanced-updater_1">Advanced updater<a class="headerlink" href="#advanced-updater_1" title="Permanent link">#</a></h5>
<p>For advanced update management a script needs to run at the server side, for example a PHP script.
At every update request the ESP sends some information in HTTP headers to the server.</p>
<p>Example header data:</p>
<pre><code>    [HTTP_USER_AGENT] =&gt; ESP8266-http-Update
    [HTTP_X_ESP8266_STA_MAC] =&gt; 18:FE:AA:AA:AA:AA
    [HTTP_X_ESP8266_AP_MAC] =&gt; 1A:FE:AA:AA:AA:AA
    [HTTP_X_ESP8266_FREE_SPACE] =&gt; 671744
    [HTTP_X_ESP8266_SKETCH_SIZE] =&gt; 373940
    [HTTP_X_ESP8266_SKETCH_MD5] =&gt; a56f8ef78a0bebd812f62067daf1408a
    [HTTP_X_ESP8266_CHIP_SIZE] =&gt; 4194304
    [HTTP_X_ESP8266_SDK_VERSION] =&gt; 1.3.0
    [HTTP_X_ESP8266_VERSION] =&gt; DOOR-7-g14f53a19
</code></pre>

<p>With this information the script now can check if an update is needed. It is also possible to deliver different binaries based on the MAC address for example.</p>
<p>Script example:</p>
<pre><code class="php">&lt;?PHP

header('Content-type: text/plain; charset=utf8', true);

function check_header($name, $value = false) {
    if(!isset($_SERVER[$name])) {
        return false;
    }
    if($value &amp;&amp; $_SERVER[$name] != $value) {
        return false;
    }
    return true;
}

function sendFile($path) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 200 OK', true, 200);
    header('Content-Type: application/octet-stream', true);
    header('Content-Disposition: attachment; filename='.basename($path));
    header('Content-Length: '.filesize($path), true);
    header('x-MD5: '.md5_file($path), true);
    readfile($path);
}

if(!check_header('HTTP_USER_AGENT', 'ESP8266-http-Update')) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 403 Forbidden', true, 403);
    echo &quot;only for ESP8266 updater!\n&quot;;
    exit();
}

if(
    !check_header('HTTP_X_ESP8266_STA_MAC') ||
    !check_header('HTTP_X_ESP8266_AP_MAC') ||
    !check_header('HTTP_X_ESP8266_FREE_SPACE') ||
    !check_header('HTTP_X_ESP8266_SKETCH_SIZE') ||
    !check_header('HTTP_X_ESP8266_SKETCH_MD5') ||
    !check_header('HTTP_X_ESP8266_CHIP_SIZE') ||
    !check_header('HTTP_X_ESP8266_SDK_VERSION')
) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 403 Forbidden', true, 403);
    echo &quot;only for ESP8266 updater! (header)\n&quot;;
    exit();
}

$db = array(
    &quot;18:FE:AA:AA:AA:AA&quot; =&gt; &quot;DOOR-7-g14f53a19&quot;,
    &quot;18:FE:AA:AA:AA:BB&quot; =&gt; &quot;TEMP-1.0.0&quot;
);

if(!isset($db[$_SERVER['HTTP_X_ESP8266_STA_MAC']])) {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 500 ESP MAC not configured for updates', true, 500);
}

$localBinary = &quot;./bin/&quot;.$db[$_SERVER['HTTP_X_ESP8266_STA_MAC']].&quot;.bin&quot;;

// Check if version has been set and does not match, if not, check if
// MD5 hash between local binary and ESP8266 binary do not match if not.
// then no update has been found.
if((!check_header('HTTP_X_ESP8266_SDK_VERSION') &amp;&amp; $db[$_SERVER['HTTP_X_ESP8266_STA_MAC']] != $_SERVER['HTTP_X_ESP8266_VERSION'])
    || $_SERVER[&quot;HTTP_X_ESP8266_SKETCH_MD5&quot;] != md5_file($localBinary)) {
    sendFile($localBinary);
} else {
    header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 304 Not Modified', true, 304);
}

header($_SERVER[&quot;SERVER_PROTOCOL&quot;].' 500 no version for ESP MAC', true, 500);

</code></pre>

<h2 id="stream-interface">Stream Interface<a class="headerlink" href="#stream-interface" title="Permanent link">#</a></h2>
<p>TODO describe Stream Interface</p>
<p>The Stream Interface is the base for all other update modes like OTA, http Server / client.</p>
<h2 id="updater-class">Updater class<a class="headerlink" href="#updater-class" title="Permanent link">#</a></h2>
<p>Updater is in the Core and deals with writing the firmware to the flash, 
checking its integrity and telling the bootloader to load the new firmware on the next boot.</p>
<h3 id="update-process-memory-view">Update process - memory view<a class="headerlink" href="#update-process-memory-view" title="Permanent link">#</a></h3>
<ul>
<li>The new sketch will be stored in the space between the old sketch and the spiff.</li>
<li>on the next reboot the &ldquo;eboot&rdquo; bootloader check for commands.</li>
<li>the new sketch is now copied &ldquo;over&rdquo; the old one.</li>
<li>the new sketch is started.</li>
</ul>
<p><img alt="Memory Copy" src="../images/update_memory_copy.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../arduino-esp8266-hardware/" class="btn btn-neutral float-right" title="Phần cứng hỗ trợ">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../filesystem/flash-layout/" class="btn btn-neutral" title="Flash Layout"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://esp8266.vn">ESP8266 Viet Nam</a></p>
    
  </div>

  
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<!-- <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/esp8266vn/esp8266.vn" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../filesystem/flash-layout/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../arduino-esp8266-hardware/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div> -->

<script type="text/javascript">
  // If cookie is defined toggle the id
  if (typeof $.cookie('docToggle') !== 'undefined') {
      // Parse cookie which is an array
      var _parsed_cookie = JSON.parse($.cookie('docToggle'));
      // Loop over array and show hidden divs
      $.each(_parsed_cookie, function(index, value) {
          // Toggle
          $("[id='hidden_" + value + "']").css('display','');
      })
  }
</script>

</body>
</html>